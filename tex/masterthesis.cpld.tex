\section{Implicit Finite-Volume Method for Incompressible Flows -- Fully Coupled Approach}
\label{sec:cpld}

Since the antecedent section \ref{sec:seg} already discussed the discretization details on the involved equations, this section aims at a comparison at the algorithmic level of the SIMPLE algorithm, presented in section \ref{sec:simple}, as a method to resolve the pressure-velocity coupling, and an implementation of a fully coupled solution algorithm. It should be noted that the discretization of the equations to be solved is not changed in any way to maintain comparability, so the presented differences are exclusively due to difference in the solution algorithm. Successful implementations of a fully coupled solution algorithm for incompressible Navier-Stokes equations have been presented in \cite{chen10,darwish09,falk13,vakilipour12}. In addition the presented work will extend the solution approach presented in \cite{falk13} to three-dimensional domains. Furthermore this section will present various approaches to incorporate different degrees of velocity-to-temperature and temperature-to-velocity/pressure coupling. Finally the structure of the resulting linear system to be solved is discussed.

\subsection{The Fully Coupled Algorithm -- Pressure-Velocity Coupling Revised}

This subsection motivates the use of a fully coupled algorithm to resolve pressure-velocity coupling and mentions the differences to the approach presented in subsection \ref{sec:simple}. The mentioned subsection presented a common solution approach to solve incompressible Navier-Stokes equations: After the linearization of the equations, momentum balances were solved using the pressure from the previous iteration as a guess. Since in general the velocity field obtained by solving a momentum balance with a guessed pressure does not obey continuity, the velocity field and the pressure field had to be corrected. This in turn would lead to an inferior solution regarding the residual of the momentum balances. To avoid this iterative guess-and-correct solution process another class of approaches to the pressure-velocity coupling problematic, represented by algorithms that are \emph{fully coupled}, will be introduced now. . 

The central aspect of fully coupled solution methods for Navier-Stokes equations is, that instead of solving for the velocities and pressure corrections sequentially, the velocity field and the pressure are solved for simultaneously \cite{schaefer99}, so every velocity field that is calculated obeys conservation of momentum and mass, without the need to be corrected. As a result the under-relaxation of pressure and velocities is no longer required, which accelerates convergence significantly in terms of needed outer iterations. The only reason for still needing an iterative solution process is the non-linearity of the Navier-Stokes equations which is accounted for by the use of the Picard iteration process, which has been presented in subsection \ref{sec:nonlinear}. The iterations fortunately make room for deferred corrections as introduced in subsection \ref{sec:segdiscretization}. It should be noted that it is also possible to use the coupled solution algorithm to calculate pressure corrections. Reference \cite{klaij13} uses this approach to solve the Navier-Stokes equations.

On the downside implementations of fully coupled solution methods require significantly more system memory than segregated methods. This is due to the higher amount of information that has to be available at the same time and the resulting linear systems which also require more memory, due to the increased amount of unknowns to solve for. Furthermore the bad condition of the linear algebraic system \cite{schaefer99} tends to slow down the convergence of the equation solver algorithm.

As in the case of segregated methods it is not advisable to solve the mass balance equation directly \cite{schaefer99}. Instead of deriving an equation for the pressure correction \(p'\), as shown in \ref{sec:simple}, an equation for the pressure is derived by using the pressure-weighted interpolation method, which has been introduced in \ref{sec:massflux} and is used to approximate the velocities in the discretized mass balance (\ref{eq:massbalance}). Concretely equation (\ref{eq:pwim}) is adapted for the use in a fully coupled algorithm
\begin{displaymath}
  u_{i,f}^{(n)} 
  =
  \left[\left(1 - \gamma_f\right) u_{i,P}^{(n)} + \gamma_f u_{i,Q}^{(n)} \right]
  - \left(\left(1 - \gamma_f\right) \frac{V_P}{a_P^{u_i}} + \gamma_f \frac{ V_Q}{a_Q^{u_i}}\right)
  \left[ 
    \underline{ \left(\frac{\partial p}{\partial x_i}\right)_f^{(n)}}
  - \frac{1}{2} 
  \left( 
    \left( \frac{\partial p}{\partial x_i} \right)_P^{(n-1)} 
  + \left(\frac{\partial p}{\partial x_i}\right)_Q^{(n-1)} 
  \right)
  \right].
\end{displaymath}
The changes comprise the removal of last term of (\ref{eq:pwim}) accounting for the under-relaxation, since no under-relaxation is needed in fully coupled algorithms which is equivalent to an under-relaxation factor \(\alpha_\vec{u} = 1\). Furthermore the underlined partial derivatives are now going to be treated implicitly. This leads to the semi-implicit pressure equation
\begin{align}
  \sum_{F \in NB(P)} 
  \rho
  \left[\left(1 - \gamma_f\right) u_{i,P}^{(n)} + \gamma_f u_{i,F}^{(n)} \right]\,  S_f
  - \rho \left(\left(1 - \gamma_f\right) \frac{ V_P}{a_P^{u_i}} + \gamma_f \frac{ V_F}{a_F^{u_i}}\right)
  \left[ 
  \left(\frac{\partial p}{\partial x_i}\right)_f^{(n)}
  \right]\,  S_f \nonumber \\
  =
  - \sum_{F \in NB(P)}
  \rho
  \left(\left(1 - \gamma_f\right) \frac{ V_P}{a_P^{u_i}} + \gamma_f \frac{ V_F}{a_F^{u_i}}\right)
  \left[ 
  \frac{1}{2} 
  \left( 
    \left( \frac{\partial p}{\partial x_i} \right)_P^{(n-1)} 
  + \left(\frac{\partial p}{\partial x_i}\right)_F^{(n-1)} 
  \right)
  \right] \, S_f.
\end{align}

Even though this equation is solved for the pressure \(p\) while equation (\ref{eq:presscorr}) is solved for the pressure correction \(p'\) the matrix coefficients from the pressure correction discretization of equation (\ref{eq:segpresscorrcoeff}) and the calculation of the right hand side is given in equation (\ref{eq:presscorrb}). For the implicit coupling to the velocities \(u_i\) additional matrix coefficients have to be considered. These can be calculated as
\begin{displaymath}
  a_F^{p,u_i} = \rho \, \gamma_f S_f \quad \text{and} \quad a_P^{p,u_i} = \sum_{F \in NB(P)} \rho \, (1-\gamma_f) \, S_f.
\end{displaymath}

On the other side the discretized momentum balance gives matrix coefficients to account for the implicit velocity-pressure coupling. They are calculated as
\begin{displaymath}
  a_F^{u_i,p} =  \gamma_f S_f \quad \text{and} \quad a_P^{u_i,p} = \sum_{F \in NB(P)} (1-\gamma_f) \, S_f.
\end{displaymath}
If the Boussinesq approximation is used implicitly, an additional coefficient \(a_P^{u_i,T}\) to account for the velocity temperature coupling has to be considered. This will be handled in subsection \ref{sec:temperaturecoupling}

\alglanguage{pseudocode}
\begin{algorithm}
\label{al:coupled}
\caption{Fully Coupled Solution Algorithm}
\begin{algorithmic}
\State{\textit{INITIALIZE} variables}
\While{(convergence criterion not accomplished)}
\If{(temperature coupling)}
  \State{\textit{SOLVE} the linear system for velocities, pressure and temperature}
\Else
  \State{\textit{SOLVE} the linear system for velocities and pressure}
\EndIf
\State{\textit{CALCULATE} mass fluxes using REFERENCE}
\If{(decoupled scalar equation)}
  \State{\textit{SOLVE} scalar equation as described in \textbf{(\ref{sec:discretetemperature})}}
\EndIf
\EndWhile
\end{algorithmic}
\end{algorithm}

\subsection{Coupling to the Temperature Equation}
\label{sec:temperaturecoupling}

Since the present work also aims at analyzing the efficiency of different methods to couple the temperature equation to the velocities and vice-versa this subsection discusses different approaches to handle the coupling of the temperature equation to the Navier-Stokes equations if the Boussinesq-Approximation, as introduced in subsection \ref{sec:boussinesq}, is used. The effectiveness of realizing a strong coupling of the temperature equation to the Navier-Stokes equations depends on the flow problem. The physical coupling tends to increase in flow scenarios of natural convection, where the temperature difference and hence the buoyancy term in the Navier-Stokes equations dominates the fluid movement. Generally speaking: The higher the physical coupling of temperature and flow, the greater are the benefits of using an implementation that uses a strong coupling to the temperature equation. The following subsections present different approaches that can be used for different intensities of coupling.
      
\subsubsection{Decoupled Approach -- Explicit Velocity-to-Temperature Coupling}

The decoupled approach is similar to the treatment of the velocity-temperature coupling described in subsection \ref{sec:segdiscretization}. If this approach is chosen no special measures have to be taken. The momentum balances receive a contribution \( b_P^{u_i,T}\) with
\begin{displaymath}
  b_P^{u_i,T} := - \rho \beta \left( T_P^{(n-1)} - T_0 \right) V_P,
\end{displaymath}
that handles the coupling explicitly by using the temperature result of the previous outer iteration. In some cases it might be necessary to under-relax the temperature each iteration

\subsubsection{Implicit Velocity-to-Temperature Coupling}

In the same way it is possible to realize the coupling described in the previous subsection by implicitly considering the temperature in the momentum balances, which leads to an additional matrix coefficient \(a_P^{u_i,T}\) and an additional contribution to the right hand side accounting for the coupling to the temperature equation
\begin{displaymath}
  a_P^{u_i,T} = \rho \beta V_P 
  \quad \text{and} \quad
  b_P^{u_i,T} = \rho \beta T_0 V_P.
\end{displaymath}

\subsubsection{Temperature-to-Velocity/Pressure Coupling -- Newton-Raphson Linearization}
\label{sec:nrcoupled}

The previous section discussed the velocity temperature coupling and so far only the momentum balances were affected by the realization of the coupling methods. Independently it is possible to couple the temperature equation not only to the momentum balances but also to the pressure equation. In section \ref{sec:discretetemperature} the non-linear partial differential equation was linearized using a Picard iteration method. Specifically the convective term \(\rho u_j T\) was linearized by taking the mass flux from the antecedent solve of the momentum and pressure correction equations. If the decoupled approach is used, this treatment remains valid. But, if an implicit temperature coupling is sought, a coupling of the temperature equation to the momentum balances which considers the mass fluxes is desirable. Methods that exhibit the described property can be found in \cite{galpin86,oliveira01,sheu04,vakilipour12}. A common denomination of the therein used linearization method is called \emph{Newton-Raphson linearization} which can be interpreted as a bilinear approximation of the convective term by the linear terms of the respective Taylor polynomial.

The Newton-Raphson linearization technique is applied to the convective term of the temperature equation as follows. A first order Taylor approximation of the mass specific convective flux through the boundary face \(S_f\) around the \((n-1)\)st iteration value yields for the approximation at the \(n\)th iteration
\begin{align*}
  \left(u_{j,f} T_f \right)^{(n)} 
  &\approx 
  \left(u_{j,f} T_f \right)^{(n-1)} 
  + \frac{\partial}{\partial u_{j,f}}\left( u_{j,f} T_f \right)^{(n-1)} \left(u_{j,f}^{(n)} - u_{j,f}^{(n-1)} \right) 
  + \frac{\partial}{\partial T_f}\left( u_{j,f} T_f \right)^{(n-1)} \left( T_f^{(n)} - T_f^{(n-1)} \right) \\[0.5em]
  &=
  (u_{j,f} T_f )^{(n-1)} 
  + \vphantom{(u_{j,f} T_f)}{T_f}^{(n-1)} (\vphantom{(u_{j,f} T_f)}{u_{j,f}}^{(n)} - \vphantom{(u_{j,f} T_f)}{u_{j,f}}^{(n-1)} ) 
  +  \vphantom{(u_j T)}{u_{j,f}}^{(n-1)} ( \vphantom{(u_j T)}{T_f}^{(n)} - \vphantom{(u_j T)}{T_f}^{(n-1)} ) \\[0.7em]
  &=
  \underline{\vphantom{(u_j T)}{u_{j,f}}^{(n-1)} \vphantom{(u_{j,f})}{T_f}^{(n)}}  + \vphantom{(u_{j,f} T_f)}{u_{j,f}}^{(n)} \vphantom{(u_jT)}{T_f}^{(n-1)}  -  \vphantom{(u_j T)}{u_{j,f}}^{(n-1)} \vphantom{(u_j T)}{T_f}^{(n-1)}.
\end{align*}
A comparison with section \ref{sec:segconvective} shows, that the underlined term coincides with the term from the usual linearization. The first of the two new terms will be treated implicitly and explicitly after using the pressure-weighted interpolation method from section \ref{sec:pwim} to interpolate the value of \(u_{j,f}\). The second term will be treated explicitly. The use of the pressure-weighted interpolation method does not only create a temperature-to-velocity but also a temperature-to-pressure coupling. Applying the pressure-weighted interpolation, the equation for the mass specific convective flux reads
\begin{align*}
  \left(u_{j,f} T_f \right)^{(n)} 
  &\approx 
  \underline{\vphantom{(u_j T)}{u_{j,f}}^{(n-1)} \vphantom{(u_{j,f})}{T_f}^{(n)}} + \vphantom{(u_jT)}{T_f}^{(n-1)}  \left[\left(1 - \gamma_f\right) u_{j,P}^{(n)} + \gamma_f u_{j,Q}^{(n)} \right] \nonumber\\[1em]
    &\quad\quad 
    - T_f^{(n-1)}\left(\left(1 - \gamma_f\right) \frac{\alpha_\vec{u} V_P}{a_P^{u_j}} + \gamma_f \frac{\alpha_\vec{u} V_Q}{a_Q^{u_j}}\right)
    \left[ 
    \left(\frac{\partial p}{\partial x_j}\right)_f^{(n)} 
    -  \frac{1}{2} \left( \frac{\partial p}{\partial x_j} \right)_P^{(n-1)} 
    - \frac{1}{2} \left(\frac{\partial p}{\partial x_j}\right)_Q^{(n-1)} 
    \right] \nonumber \\[1em]
    &  \quad\quad -\vphantom{(u_j T)}{u_{j,f}}^{(n-1)} \vphantom{(u_j T)}{T_f}^{(n-1)}.
\end{align*}
If this semi-implicit, semi-discrete equation is discretized completely new matrix and contributions can be calculated
\begin{align*}
  \allowdisplaybreaks
  &a_F^{T,u_i} = \rho T_f^{(n-1)} \gamma_f n_{f,i} S_f \\[1.0em] 
  &a_P^{T,u_i} = \sum_{F \in NB(P)} \rho T_f^{(n-1)} \left(1-\gamma_f\right) n_{f,i} S_f \\[1.0em]
  &a_F^{T,p} = -\rho T_f^{(n-1)} \left(\left(1 - \gamma_f\right) \frac{\alpha_\vec{u} V_P}{a_P^{u_i}} + \gamma_f \frac{\alpha_\vec{u} V_F}{a_F^{u_i}}\right) \frac{S_f}{\left(\vec{x}_P - \vec{x}_F\right) \cdot \vec{n}_f} = \rho T_f^{(n-1)} a_F^{p} \\[1.0em] 
  &\text{and} \quad
  a_P^{T,p} = - \sum_{F \in NB(P)} T_f^{(n-1)} a_F^{T,p}.
\end{align*}
The explicit parts resulting from the Newton-Raphson linearization yield additional contributions to the right hand side
\begin{displaymath}
  b_P^{T,\text{NR}} 
  = 
  \rho u_{j,f}^{(n-1)} T_f^{(n-1)} n_{f,j} S_f 
  - \rho T_f^{(n-1)} \left(\left(1 - \gamma_f\right) \frac{\alpha_\vec{u} V_P}{a_P^{u_j}} + \gamma_f \frac{\alpha_\vec{u} V_Q}{a_Q^{u_j}}\right)
    \left[ 
    \frac{1}{2} \left( \frac{\partial p}{\partial x_j} \right)_P^{(n-1)} 
    + \frac{1}{2} \left(\frac{\partial p}{\partial x_j}\right)_Q^{(n-1)} 
    \right] n_{j,f} S_f
\end{displaymath}

\subsection{Boundary Conditions on Domain and Block Boundaries}

The treatment of boundary conditions and transitional conditions at block boundaries is very similar to the way presented in section \ref{sec:segboundary}. The main difference results from the fact that in addition to the necessary changes from section \ref{sec:segboundary}, modifications are necessary to the new matrix coefficients from the discretized momentum balance and the pressure equation in the coupled solution algorithm. The purpose of this section is therefore to only focus on these additional changes.

How Dirichlet boundary conditions, also known as inlet boundaries, affect the matrix coefficients that only correspond to the velocities has been presented in section \ref{sec:segdirichlet}. It is common to use Neumann boundary conditions for the pressure at Dirichlet boundaries with respect to the velocities \cite{darwish09}. Under the assumption that the gradient of the pressure vanishes at inlet boundaries, the matrix coefficients for the velocity-to-pressure coupling have to be modified to 
\begin{displaymath}
  a_P^{u_i,p} = a_P^{u_i,p} + n_{f,i} S_f.
\end{displaymath}
Wall boundary conditions are treated likewise with the additional modifications to the right hand side contribution as presented in section \ref{sec:walls}.

The treatment of velocity Dirichlet boundary conditions in the pressure equation is straightforward, since the correspond to mass fluxes through the boundary faces. Hence the matrix coefficients remain unchanged and only the right hand side contributions embrace the fact that no implicit interpolation is necessary to calculate the mass flux through the boundary face.

Finally it should be noted that the that the Newton-Raphson linearization technique does not apply to the velocities on boundary faces, since the value of the velocities is known exactly and a linearization of the convective contribution becomes unnecessary.

%\subsubsection{Dirichlet Boundary Condition for Pressure} NOT TO BE USED

At block boundaries the new matrix coefficients \(a_L^{u_i,p}\) and \(a_R^{u_i,p}\) for the velocity-to-pressure coupling and the matrix coefficients \(a_L^{p,u_i}\) and \(a_R^{p,u_i}\) have to be taken into account. This does not present any drawbacks on the presented approach.

\subsection{Assembly of Linear Systems -- Final Form of Equations}

Concluding this section presents the final for of the derive linear algebraic equations. Based on the presented discretization each equation only contains variable values of neighbouring control volumes. The set of five equations reads
\begin{align}
  a_P^{u_i} u_{P,i} + \sum_{F \in NB(P)} a_F^{u_i} u_{F,i} + \underbrace{\vphantom{\sum_F}{a_P^{u_i,p} p_P+ \sum_{F \in NB(P)} a_F^{u_i,p} p_F}}_{\hbox{Pressure-velocity coupling}} + \underbrace{\vphantom{\sum_F}{ a_P^{u_i,T} T_P}}_{\hbox{Boussinesq approximation}} &= b_{P,u_i} \quad i=1,...,3  \\[2.0em]
  a_P^{p} p_{P} + \sum_{F \in NB(P)} a_F^{p} p_F + \underbrace{ \sum_{j=1}^3 \left(a_P^{u_j,p} u_{P,j}+ \sum_{F \in NB(P)} a_F^{p,u_j} u_{F,j} \right)}_{\hbox{Pressure-velocity coupling}} &= b_{P,p}  \\[2.0em]
  a_P^{T} T_{P} + \sum_{F \in NB(P)} a_F^{T} T_F + \underbrace{\sum_{j=1}^3 \left(a_P^{T,u_j} u_{P,j}+ \sum_{F \in NB(P)} a_F^{p,u_i} u_{F,i} \right) + a_P^{T,p} p_P + \sum_{F \in NB(P) } a_F^{T,p} p_F}_{\hbox{Newton-Raphson linearization}} &= b_{P,T}.
\end{align}


The different degrees of coupling between the different equations will affect the matrix structure. Depending on the variable arrangement other matrix structures are possible. Figure \ref{fig:cpldassemble} shows the resulting block matrix structure if the fields are treated as interlaced quantities. Figure \ref{noidea} shows the non-zero structure of a block matrix for the same case if no field interlacing is used. It should be noted, that the variable arrangement only affects the storage of the matrices not the way the matrix is used, since it is possible to arbitrarily reorder the matrix entries through the underlying index sets to obtain other matrix representations.

\begin{figure}
  \centering
  \label{fig:cpldassemble}
  \input{./img/coupledmat.tikz.tex}
  \caption{Non-zero structure of block submatrices of the linear systems used in the coupled solution algorithm for a block structured grid consisting of one $2\times2\times2$ cell and one $3\times3\times3$ cell block. The blue coefficients represent the pressure-velocity coupling, the red coefficients correspond to the velocity-to-temperature coupling and the green coefficients result from the Newton-Raphson linearization technique.}
\end{figure}

\begin{figure}
  \centering
  %\label{fig:cpldassemble}
  \input{./img/interlacemat.tikz.tex}
  \caption{Non-zero structure of the linear system used in the coupled solution algorithm for a block structured grid consisting of one $2\times2\times2$ cell and one $3\times3\times3$ cell block. The variables have been interlaced and the matrix consists of blocks as shown in figure \ref{fig:cpldassemble}.}
\end{figure}

\begin{figure}
  \centering
  %\label{fig:cpldassemble}
   \input{./img/nointerlacemat.tikz.tex}
  \caption{Non-zero structure the linear system used in the coupled solution algorithm for a block structured grid consisting of one $2\times2\times2$ cell and one $3\times3\times3$ cell block. The variables have been ordered such that each major matrix block refers to only one variable or the coupling between exactly two variables.}
  \label{fig:nointerlacemat}
\end{figure}
